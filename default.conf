upstream todo-app {
    server todo-app:80;
}

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    gzip on;
    gzip_types text/plain application/xml application/javascript text/css application/json image/svg+xml;
    gzip_min_length 256;

    location ~ ^/([^/]+)/remoteEntry\.js$ {
        set $remote_name $1;
        proxy_pass http://$remote_name-app/remoteEntry.js;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache";
    }

    location ~ ^/([^/]+)/(.*\.(?:js|css|png|jpe?g|gif|svg|woff2?|ttf))$ {
        set $remote_name $1;
        set $asset_path   $2;
        proxy_pass http://$remote_name-app/$asset_path;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
    }

    location ~ ^/([^/]+)/ {
        set $remote_name $1;
        proxy_pass http://$remote_name-app/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache";
    }

    location / {
        try_files $uri /index.html;
        add_header Cache-Control "no-cache";
    }
}
